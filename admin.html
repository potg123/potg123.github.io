<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nova Pet Admin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.6.0/decimal.min.js"></script>
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#8a9099; --accent:#6aa0ff;
    --ok:#35c759; --warn:#ffb300; --bad:#ff5171; --chip:#232a36;
    --ring:#1f2530; --text:#e8ecf3; --highlight:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0; background:#0f1115; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #232a36;background:#0c1016;position:sticky;top:0;z-index:10}
  .brand{font-weight:700}
  .grid{max-width:1200px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns: 340px 1fr;gap:14px}
  .card{background:#161a22;border:1px solid #232a36;border-radius:12px; padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .col{flex:1 1 0}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 0 4px 2px}
  input,textarea,select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3040;
    background:#0e1218; color:#e8ecf3; outline:none; font-size:14px;
  }
  textarea{min-height:84px; resize:vertical}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid #334055;background:#142033;color:#cfe1ff;cursor:pointer;font-weight:600}
  .btn:hover{filter:brightness(1.06)}
  .btn.primary{background:linear-gradient(180deg,#2b71ff,#1d56cc);border-color:transparent;color:white}
  .btn.ghost{background:transparent}
  .btn.warn{border-color:#7a1e2e;background:#2a0f16;color:#ff8aa0}
  .list{max-height:52vh;overflow:auto;border:1px solid #2a3040;border-radius:10px}
  .item{padding:10px 12px;border-bottom:1px solid #222836;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer}
  .item:hover{background:#141924}
  .muted{color:var(--muted)}
  .tags{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .tag{font-size:11px;border:1px solid #2b3242;border-radius:999px;padding:2px 8px}
  .tag.ok{border-color:#275a34;background:#102214;color:#35c759}
  .tag.warn{border-color:#7a5b0e;background:#241a05;color:#ffb300}
  .tag.bad{border-color:#5a1e2a;background:#201016;color:#ff7e92}
  .grid2{display:grid;grid-template-columns: repeat(4,1fr);gap:8px}
  .grid3{display:grid;grid-template-columns: repeat(3,1fr);gap:8px}
  .hr{height:1px;background:#242a36;margin:10px -12px}
  .note{font-size:12px;color:#b8bfd0}
  .callout{border:1px solid #334055;background:#0f1420;border-radius:10px;padding:10px 12px}
  .callout.bad{border-color:#5a1e2a;background:#1a0f14}
  .callout.ok{border-color:#275a34;background:#0f1912}
  .right{display:flex;gap:8px;align-items:center}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

  /* ===== 8확정 리스트 정렬 고정 ===== */
  .r8list{max-height:36vh; overflow:auto; border:1px solid #2a3040; border-radius:10px; padding:6px}
  .r8item{
    display:grid;
    grid-template-columns: 22px 1fr auto; /* 체크박스 | 이름 | 태그 */
    gap:8px; align-items:center; padding:8px; border-bottom:1px solid #222836; border-radius:8px;
  }
  .r8item:last-child{border-bottom:none}
  .r8item input[type=checkbox]{ width:18px; height:18px; }
  .r8item.disabled{opacity:.55}
  .r8item .name{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .r8item .extra{display:flex; gap:6px; align-items:center; justify-self:end; flex-wrap:wrap}

  /* 모바일 최적화 */
  @media (max-width: 780px){
    .grid{grid-template-columns:1fr;gap:10px}
    header{flex-wrap:wrap;gap:8px}
    .list{max-height:32vh}
    input,textarea,select{font-size:16px;padding:12px 14px}
    .btn{padding:12px 14px}
    .grid2{grid-template-columns: repeat(2,1fr)}
    .grid3{grid-template-columns: repeat(2,1fr)}
    .r8item{ grid-template-columns: 24px 1fr; }
    .r8item .extra{ grid-column: 2 / 3; justify-self:start; margin-top:2px; }
  }

  /* === 비밀번호 게이트 === */
  body.locked{overflow:hidden}
  body.locked header, body.locked .grid{display:none}
  #gate{
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    background:rgba(15,17,21,.94)
  }
  #gate .panel{
    width:min(420px,92vw); border-radius:14px; padding:18px;
    background:#161a22; border:1px solid #232a36; color:#e8ecf3
  }
  #gate h2{margin:0 0 10px; font-size:18px}
  #gate .row{display:flex; gap:8px; margin-top:8px}
  #gate input{
    flex:1 1 auto; padding:12px; border-radius:10px; border:1px solid #2a3040;
    background:#0e1218; color:#e8ecf3; outline:none; font-size:14px
  }
  #gate button{
    padding:12px 14px; border-radius:10px; border:1px solid #334055;
    background:#142033; color:#cfe1ff; font-weight:600; cursor:pointer
  }
  #gate .err{margin-top:8px; color:#ff7e92; font-size:13px; min-height:18px}
</style>
</head>
<body class="locked">
  <!-- 비밀번호 게이트 -->
  <div id="gate" role="dialog" aria-modal="true">
    <div class="panel">
      <h2>Nova Pet Admin</h2>
      <div class="muted" style="font-size:13px">접근을 위해 비밀번호를 입력하세요.</div>
      <div class="row">
        <input id="gate_pass" type="text" placeholder="Password" autocomplete="current-password" />
        <button id="gate_btn">입장</button>
      </div>
      <div id="gate_err" class="err"></div>
      <div style="display: flex; justify-content: flex-start; align-items: center;">
        <label style="display:flex;align-items:center;gap:4px;font-size:13px;color:#8a9099;">
          <input id="gate_rem" type="checkbox" style="width:14px; height:14px;"> 브라우저 탭에서 2시간 기억하기
        </label>
      </div>
    </div>
  </div>

<header>
  <div class="brand">Nova Pet Admin — 오버라이드 + 8확정 집계</div>
  <div class="right">
    <button class="btn" id="btnReload">원격 새로고침</button>
    <button class="btn ghost" id="btnExport">로컬 다운로드</button>
    <button class="btn primary" id="btnCommit">GitHub 커밋 (pets.json)</button>
  </div>
</header>

<div class="grid">
  <!-- 좌: 목록 -->
  <section class="card">
    <div class="row" style="margin-bottom:8px">
      <input id="search" placeholder="이름 검색" />
      <button class="btn" id="btnNew">+ 새 페트</button>
    </div>
    <div class="list" id="list"></div>
  </section>

  <!-- 우: 에디터 -->
  <section class="card">
    <div class="row">
      <div class="col">
        <label>이름</label>
        <input id="name" placeholder="예: 골로스" />
      </div>
      <div class="col">
        <label>메모(선택)</label>
        <input id="note" placeholder="관리자 메모(내부용)" />
      </div>
    </div>

    <div class="hr"></div>

    <div>
      <label>표기 초기치 S0 (체/공/방/순)</label>
      <div class="grid2">
        <input id="s0_hp"  type="number" step="0.01" placeholder="hp 67.62" />
        <input id="s0_atk" type="number" step="0.01" placeholder="atk 14.83" />
        <input id="s0_def" type="number" step="0.01" placeholder="def 9.54" />
        <input id="s0_agi" type="number" step="0.01" placeholder="agi 8.26" />
      </div>
    </div>

    <div style="margin-top:10px">
      <label>표기 성장치 Sg (체/공/방/순)</label>
      <div class="grid2">
        <input id="sg_hp"  type="number" step="0.01" placeholder="hp 10.51" />
        <input id="sg_atk" type="number" step="0.01" placeholder="atk 2.30" />
        <input id="sg_def" type="number" step="0.01" placeholder="def 1.48" />
        <input id="sg_agi" type="number" step="0.001" placeholder="agi 1.283" />
      </div>
    </div>

    <div class="hr"></div>

    <div class="row" style="align-items:center">
      <label style="margin:0 8px 0 2px">
        <input type="checkbox" id="ovr_check" /> 수동 오버라이드(k/u 강제)
      </label>
      <button class="btn" id="btnSolve">S0/SG로 k/u 추정</button>
      <button class="btn warn" id="btnClearKU">오버라이드 해제</button>
      <span class="note">※ 아래 k/u는 <b>원래 u(JJYAL)</b> 기준으로 입력/저장/연산됩니다.</span>
    </div>

    <div class="row" style="margin-top:8px">
      <div style="min-width:120px">
        <label>k</label>
        <input id="ku_k" type="number" step="1" placeholder="예: 28" />
      </div>
      <div class="col">
        <label>u (hp / atk / def / agi) — <span class="muted">원래 u</span></label>
        <div class="grid2">
          <input id="ku_hp"  type="number" step="1" placeholder="예: 31" />
          <input id="ku_atk" type="number" step="1" placeholder="예: 41" />
          <input id="ku_def" type="number" step="1" placeholder="예: 20" />
          <input id="ku_agi" type="number" step="1" placeholder="예: 25" />
        </div>
      </div>
    </div>

    <div id="consistency" class="callout" style="margin-top:10px;display:none"></div>

    <div class="hr"></div>

    <div class="row">
      <button class="btn primary" id="btnSave">저장(브라우저)</button>
      <button class="btn" id="btnSaveCommit">저장 후 pets.json 커밋</button>
      <span class="note">커밋은 GitHub 토큰 필요</span>
    </div>
  </section>

  <!-- ===== R8 집계 섹션 ===== -->
  <section class="card">
    <h3 style="margin:4px 0 10px">④ 환각(8등급) 100% 초기치 집계 & 커밋</h3>
    <div class="row" style="align-items:center;margin-bottom:8px">
      <button class="btn" id="btnR8SelectAll">모두 선택</button>
      <button class="btn ghost" id="btnR8ClearAll">선택 해제</button>
      <span class="note">k/u가 있는 페트만 선택 가능(오버라이드 포함)</span>
    </div>
    <div class="r8list" id="r8List"></div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnR8Run">선택 대상 집계</button>
      <button class="btn primary" id="btnR8Commit" disabled>guaranteed_rank8.full.json 커밋</button>
    </div>
    <div id="r8Preview" class="callout" style="margin-top:10px; display:none"></div>
  </section>
</div>

<!-- === 비밀번호 게이트 스크립트 (페이지 잠금/해제) === -->
<script>
/* ① 여기 해시값(HEX)을 바꿔 넣으세요. 예: '새_비번'의 SHA-256 HEX */
const ADMIN_PASSWORD_HASH = "4f54b251f52001921456bc83c0b29e9fa08ab1c81e431f263a9be231309f68f4";
/* ② '2시간 기억하기' 체크 시 유지 시간(ms) */
const LOGIN_TTL_MS = 2 * 60 * 60 * 1000;

async function sha256Hex(text){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function getSess(){ try{ return JSON.parse(sessionStorage.getItem("nova_admin_ok")||"null"); }catch{ return null; } }
function setSess(){ sessionStorage.setItem("nova_admin_ok", JSON.stringify({h:ADMIN_PASSWORD_HASH, t:Date.now()})); }
function sessValid(){ const s = getSess(); return !!(s && s.h===ADMIN_PASSWORD_HASH && (Date.now()-s.t) < LOGIN_TTL_MS); }
function unlock(){ document.body.classList.remove("locked"); const g = document.getElementById("gate"); if(g) g.remove(); }

document.addEventListener("DOMContentLoaded", ()=>{
  const pass = document.getElementById("gate_pass");
  const btn  = document.getElementById("gate_btn");
  const err  = document.getElementById("gate_err");
  const rem  = document.getElementById("gate_rem");

  if(sessValid()){ unlock(); return; }

  async function tryLogin(){
    err.textContent = "";
    const p = pass.value ?? "";
    if(!p){ err.textContent="비밀번호를 입력하세요."; pass.focus(); return; }
    try{
      const hex = await sha256Hex(p);
      if(hex === ADMIN_PASSWORD_HASH){
        if(rem && rem.checked) setSess();
        unlock();
      }else{
        err.textContent = "비밀번호가 올바르지 않습니다.";
        pass.value = ""; pass.focus();
      }
    }catch(e){
      err.textContent = "브라우저가 WebCrypto를 지원하지 않습니다.";
      console.error(e);
    }
  }

  btn.addEventListener("click", tryLogin);
  pass.addEventListener("keydown", e=>{ if(e.key==="Enter") tryLogin(); });
  setTimeout(()=>pass.focus(), 0);
});
</script>

<script>
/* ====== 설정 ====== */
const GH_OWNER  = "potg123";
const GH_REPO   = "potg123.github.io";
const GH_BRANCH = "main";
const PETS_PATH = "data/pets.json";
const R8_PATH   = "data/guaranteed_rank8.full.json";
const REMOTE_PETS = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${PETS_PATH}`;
const REMOTE_R8   = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${R8_PATH}`;

const LS_KEY = "adminPetsCache_v2";

/* ====== 상태 ====== */
let DB = {}; let ORDER = []; let CURRENT = null;
let R8_RESULT = {}; let R8_REMOTE_SHA = null;

/* ====== 유틸 ====== */
function fetchJSON(url){
  return fetch(url + `?v=${Date.now()}`, {cache:"no-store"})
    .then(async r => {
      if(r.status === 404) return {__404__:true};
      if(!r.ok) throw new Error("HTTP "+r.status);
      return r.json();
    });
}
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(DB)); }
function loadLS(){ try{ const s=localStorage.getItem(LS_KEY); return s? JSON.parse(s):null; }catch{ return null; } }
function sortNames(){ ORDER = Object.keys(DB).sort((a,b)=>a.localeCompare(b,'ko')); }
function $(id){ return document.getElementById(id); }
const num = (v)=> (v===""||v==null||isNaN(+v)) ? null : +v;
const floor4 = (a)=> a.map(x=>Math.floor(x??NaN));
function toFixed2(x){ return new Decimal(x).toDecimalPlaces(2, Decimal.ROUND_HALF_UP).toNumber(); }

/* ====== 추정/검증 로직 (원래 u용) ====== */
const ESET = Array.from({ length: ((575 - 435) / 5) + 1 }, (_, i) => 575 - i*5);

/* ★ S0: 원래 u를 넣으면 반드시 (u + 4.5)로 계산해야 함 */
function s0_from_k_u_jjyal(k, u){
  const fac = k/100;
  const vhp  = (u.hp + 4.5) * fac;
  const vatk = (u.atk+ 4.5) * fac;
  const vdef = (u.def+ 4.5) * fac;
  const vagi = (u.agi+ 4.5) * fac;
  const s_hp = Math.floor(vhp*4 + vatk + vdef + vagi);
  const s_atk= Math.floor(vhp*0.1 + vatk + vdef*0.1 + vagi*0.05);
  const s_def= Math.floor(vhp*0.1 + vatk*0.1 + vdef + vagi*0.05);
  const s_agi= Math.floor(vagi);
  return [s_hp,s_atk,s_def,s_agi];
}

/* ★ SG 역풀이: u.agi = round(SG.agi*10000/e - 4.5) */
function solveUFromSG_STRICT(SG,e){
  try{
    if(!SG || ![SG.hp,SG.atk,SG.def,SG.agi].every(Number.isFinite)) return null;
    Decimal.set({ precision:50, rounding: Decimal.ROUND_HALF_UP });

    const eD = new Decimal(e);
    const f  = eD.dividedBy(10000);

    const u_agi = new Decimal(SG.agi).times(10000).dividedBy(eD).minus(4.5).round();
    const dPlus45 = u_agi.plus(4.5);

    // (u.hp+4.5)*4 + (u.atk+4.5) + (u.def+4.5) + (u.agi+4.5)
    const rhs1 = new Decimal(SG.hp).minus( dPlus45.times(f) ).dividedBy(f);
    // (u.hp+4.5)*0.1 + (u.atk+4.5) + (u.def+4.5)*0.1 + (u.agi+4.5)*0.05
    const rhs2 = new Decimal(SG.atk).minus( dPlus45.times(f).times(0.05) ).dividedBy(f);
    // (u.hp+4.5)*0.1 + (u.atk+4.5)*0.1 + (u.def+4.5) + (u.agi+4.5)*0.05
    const rhs3 = new Decimal(SG.def).minus( dPlus45.times(f).times(0.05) ).dividedBy(f);

    let A = [
      [ new Decimal(4),   new Decimal(1),   new Decimal(1),   rhs1 ],
      [ new Decimal(0.1), new Decimal(1),   new Decimal(0.1), rhs2 ],
      [ new Decimal(0.1), new Decimal(0.1), new Decimal(1),   rhs3 ],
    ];
    // 가우스 소거
    for(let i=0;i<3;i++){
      let mr=i; let mv=A[i][i].abs();
      for(let j=i+1;j<3;j++){ const t=A[j][i].abs(); if(t.greaterThan(mv)){mr=j; mv=t;} }
      if(mr!==i){ const tmp=A[i]; A[i]=A[mr]; A[mr]=tmp; }
      const piv=A[i][i];
      for(let j=i;j<4;j++) A[i][j]=A[i][j].dividedBy(piv);
      for(let k=0;k<3;k++){
        if(k===i) continue;
        const fac=A[k][i];
        for(let j=i;j<4;j++) A[k][j]=A[k][j].minus( fac.times(A[i][j]) );
      }
    }
    const aPrime=A[0][3], bPrime=A[1][3], cPrime=A[2][3];

    // ★ unknown = (u + 4.5)였으므로 u = unknown - 4.5
    const u_hp  = aPrime.minus(4.5).round();
    const u_atk = bPrime.minus(4.5).round();
    const u_def = cPrime.minus(4.5).round();

    // SG 반올림 검증 (u + 4.5)
    const r2 = x => new Decimal(x).toDecimalPlaces(2, Decimal.ROUND_HALF_UP);
    const hp_chk  = r2( f.times( (u_hp.plus(4.5)).times(4).plus(u_atk.plus(4.5)).plus(u_def.plus(4.5)).plus(u_agi.plus(4.5)) ) );
    const atk_chk = r2( f.times( (u_hp.plus(4.5)).times(0.1).plus(u_atk.plus(4.5)).plus(u_def.plus(4.5).times(0.1)).plus(u_agi.plus(4.5).times(0.05)) ) );
    const def_chk = r2( f.times( (u_hp.plus(4.5)).times(0.1).plus(u_atk.plus(4.5).times(0.1)).plus(u_def.plus(4.5)).plus(u_agi.plus(4.5).times(0.05)) ) );
    const agi_chk = r2( f.times( u_agi.plus(4.5) ) );

    const ok = hp_chk.eq(r2(SG.hp)) && atk_chk.eq(r2(SG.atk)) && def_chk.eq(r2(SG.def)) && agi_chk.eq(r2(SG.agi));
    if(!ok) return null;

    return { u:{hp:+u_hp, atk:+u_atk, def:+u_def, agi:+u_agi}, e:+e };
  }catch{ return null; }
}

function inferKU_STRICT(S0, SG){
  const S0int = S0.map(x=>Math.floor(x));
  for(const e of ESET){
    const sol = solveUFromSG_STRICT(SG, e);
    if(!sol) continue;
    for(let k=10;k<=100;k++){
      const s = s0_from_k_u_jjyal(k, sol.u);
      if(s[0]===S0int[0] && s[1]===S0int[1] && s[2]===S0int[2] && s[3]===S0int[3]){
        return {k:Math.round(k), u:sol.u, e:sol.e};
      }
    }
  }
  return null;
}

/* ====== R8 집계 엔진 (원래 u 사용) ====== */
function collectR8ObsForKU(k,u){
  Decimal.set({ precision:30, rounding: Decimal.ROUND_HALF_UP });
  const fac = new Decimal(k).dividedBy(100);
  const seen = new Map();

  for(let ar=-2; ar<=2; ar++){
    for(let dr=-2; dr<=2; dr++){
      for(let gr=-2; gr<=2; gr++){
        for(let hr=-2; hr<=2; hr++){
          for(let ab=0; ab<=10; ab++){
            for(let db=0; db<=10; db++){
              for(let gb=0; gb<=10; gb++){
                const hb = 10 - ab - db - gb;
                if(hb < 0 || hb > 10) continue;

                const baseA = new Decimal(u.atk + ar + ab);
                const baseD = new Decimal(u.def + dr + db);
                const baseG = new Decimal(u.agi + gr + gb);
                const baseH = new Decimal(u.hp  + hr + hb);

                const iA = baseA.times(fac);
                const iD = baseD.times(fac);
                const iG = baseG.times(fac);
                const iH = baseH.times(fac);

                const atk = iH.times(0.1).plus(iA).plus(iD.times(0.1)).plus(iG.times(0.05)).floor().toNumber();
                const def = iH.times(0.1).plus(iA.times(0.1)).plus(iD).plus(iG.times(0.05)).floor().toNumber();
                const agi = iG.floor().toNumber();
                const hp  = iH.times(4).plus(iA).plus(iD).plus(iG).floor().toNumber();

                const key = `${hp},${atk},${def},${agi}`;
                let s = seen.get(key);
                if(!s){ s = new Set(); seen.set(key, s); }
                s.add(ar + dr + gr + hr);
              }
            }
          }
        }
      }
    }
  }
  const out = [];
  for(const [key, set] of seen.entries()){
    if(set.size===1 && set.has(8)){
      out.push(key.split(',').map(n=>+n));
    }
  }
  out.sort((a,b)=> a[0]-b[0] || a[1]-b[1] || a[2]-b[2] || a[3]-b[3]);
  return out;
}

/* ====== UI ====== */
const listEl = $("list"), searchEl = $("search");

function renderList(){
  const kw = (searchEl.value||"").trim();
  const show = ORDER.filter(n => kw ? n.includes(kw) : true);
  listEl.innerHTML = "";
  if(show.length===0){
    const d = document.createElement('div'); d.className="item"; d.textContent="결과 없음";
    listEl.appendChild(d); return;
  }
  for(const n of show){
    const row = DB[n]||{};
    const it = document.createElement('div'); it.className="item";
    const left = document.createElement('div'); left.textContent = n;
    const right = document.createElement('div'); right.className="tags";
    const t1 = document.createElement('span');
    t1.className = "tag " + (row?.s0 && row?.sg ? "ok" : "warn");
    t1.textContent = row?.s0 && row?.sg ? "S0/SG" : "미완";
    right.appendChild(t1);
    if(row?.ku_override || (Number.isFinite(row?.k) && row?.u)){
      const t2 = document.createElement('span'); t2.className="tag warn"; t2.textContent="k/u";
      right.appendChild(t2);
    }
    it.appendChild(left); it.appendChild(right);
    it.addEventListener('click', ()=>loadForm(n));
    listEl.appendChild(it);
  }
}

function loadForm(name){
  CURRENT = name;
  const r = DB[name] || {};
  $("name").value = name;
  $("note").value = r.note || "";
  $("s0_hp").value  = r?.s0?.hp  ?? "";
  $("s0_atk").value = r?.s0?.atk ?? "";
  $("s0_def").value = r?.s0?.def ?? "";
  $("s0_agi").value = r?.s0?.agi ?? "";
  $("sg_hp").value  = r?.sg?.hp  ?? "";
  $("sg_atk").value = r?.sg?.atk ?? "";
  $("sg_def").value = r?.sg?.def ?? "";
  $("sg_agi").value = r?.sg?.agi ?? "";
  $("ovr_check").checked = !!r.ku_override;
  $("ku_k").value   = r?.k ?? "";
  $("ku_hp").value  = r?.u?.hp  ?? "";
  $("ku_atk").value = r?.u?.atk ?? "";
  $("ku_def").value = r?.u?.def ?? "";
  $("ku_agi").value = r?.u?.agi ?? "";
  updateConsistency();
  renderR8List();
}

function gatherForm(){
  const name = $("name").value.trim();

  const s0 = {
    hp: num($("s0_hp").value),
    atk: num($("s0_atk").value),
    def: num($("s0_def").value),
    agi: num($("s0_agi").value)
  };
  const sg = {
    hp: num($("sg_hp").value),
    atk: num($("sg_atk").value),
    def: num($("sg_def").value),
    agi: num($("sg_agi").value)
  };

  const ovr = $("ovr_check").checked;

  let k = num($("ku_k").value);
  let u = {
    hp: num($("ku_hp").value),
    atk: num($("ku_atk").value),
    def: num($("ku_def").value),
    agi: num($("ku_agi").value)
  };
  if(!ovr){ k = null; u = null; }

  return { name, s0, sg, ovr, k, u, note: $("note").value.trim() };
}

function updateConsistency(){
  const box = $("consistency");
  box.className = "callout";
  box.style.display = "none";

  const f = gatherForm();
  const ready =
    f?.ovr &&
    Number.isFinite(f.k) &&
    f.u && [f.u.hp, f.u.atk, f.u.def, f.u.agi].every(Number.isFinite) &&
    [f.s0.hp, f.s0.atk, f.s0.def, f.s0.agi].every(Number.isFinite) &&
    [f.sg.hp, f.sg.atk, f.sg.def, f.sg.agi].every(Number.isFinite);

  if(!ready){ box.innerHTML = ""; return; }

  // S0 정수 비교 (u + 4.5)
  const sPred = s0_from_k_u_jjyal(f.k, f.u);
  const sInt  = [f.s0.hp,f.s0.atk,f.s0.def,f.s0.agi].map(v=>Math.floor(v));
  const okS0  = (sPred[0]===sInt[0] && sPred[1]===sInt[1] && sPred[2]===sInt[2] && sPred[3]===sInt[3]);

  try{
    Decimal.set({ precision:50, rounding: Decimal.ROUND_HALF_UP });

    // SG 참고 e (u + 4.5)
    const e = new Decimal(f.sg.agi).times(10000).dividedBy(new Decimal(f.u.agi).plus(4.5));
    const fct = e.dividedBy(10000);
    const r2  = x => new Decimal(x).toDecimalPlaces(2, Decimal.ROUND_HALF_UP);

    const hpC  = r2( fct.times( (f.u.hp+4.5)*4 + (f.u.atk+4.5) + (f.u.def+4.5) + (f.u.agi+4.5) ) ).toNumber();
    const atkC = r2( fct.times( (f.u.hp+4.5)*0.1 + (f.u.atk+4.5) + (f.u.def+4.5)*0.1 + (f.u.agi+4.5)*0.05 ) ).toNumber();
    const defC = r2( fct.times( (f.u.hp+4.5)*0.1 + (f.u.atk+4.5)*0.1 + (f.u.def+4.5) + (f.u.agi+4.5)*0.05 ) ).toNumber();

    const hpDiff  = toFixed2(hpC  - f.sg.hp);
    const atkDiff = toFixed2(atkC - f.sg.atk);
    const defDiff = toFixed2(defC - f.sg.def);

    const sgOk = (hpDiff===0 && atkDiff===0 && defDiff===0);
    const eVal = e.toNumber();

    box.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px">
        <strong>일관성 검사</strong>
        <span class="mono muted">k=${f.k}, u=(${f.u.hp},${f.u.atk},${f.u.def},${f.u.agi})</span>
      </div>
      <div class="${okS0?'ok':'bad'}">S0 정수부 일치: <b>${okS0?'OK':'불일치'}</b> (예측 ${sPred.join('/')}, 실제 ${sInt.join('/')})</div>
      <div style="margin-top:6px">
        <div>SG 참고(e≈<span class="mono">${eVal.toFixed(2)}</span>): 
          HP <span class="mono">${hpC.toFixed(2)}</span> (${hpDiff>=0?'+':''}${hpDiff}),
          ATK <span class="mono">${atkC.toFixed(2)}</span> (${atkDiff>=0?'+':''}${atkDiff}),
          DEF <span class="mono">${defC.toFixed(2)}</span> (${defDiff>=0?'+':''}${defDiff})
        </div>
        <div class="${sgOk?'ok':'bad'}">SG 반올림 비교: <b>${sgOk?'OK':'차이 있음'}</b></div>
      </div>
      <div class="note" style="margin-top:6px">※ k/u는 항상 <b>원래 u</b> 기준입니다.</div>
    `;
    box.classList.add(okS0 ? "ok" : "bad");
    box.style.display = "block";
  }catch{
    box.innerHTML = `<b>일관성 검사 실패</b> (내부 계산 오류)`;
    box.classList.add("bad");
    box.style.display = "block";
  }
}

/* ====== 이벤트 ====== */
$("btnReload").addEventListener("click", async ()=>{
  await loadRemote();
  alert("원격 데이터를 불러왔습니다.");
});
$("btnNew").addEventListener("click", ()=>{
  const name = prompt("새 페트 이름?");
  if(!name) return;
  if(DB[name]){ alert("이미 존재하는 이름입니다."); return; }
  DB[name] = { s0:{hp:null,atk:null,def:null,agi:null}, sg:{hp:null,atk:null,def:null,agi:null} };
  sortNames(); renderList(); loadForm(name);
});
searchEl.addEventListener("input", renderList);

$("btnSolve").addEventListener("click", ()=>{
  const f = gatherForm();
  if(!f || !f.name){ alert("이름을 입력하세요."); return; }
  if([f.s0.hp,f.s0.atk,f.s0.def,f.s0.agi].some(v=>v==null) ||
     [f.sg.hp,f.sg.atk,f.sg.def,f.sg.agi].some(v=>v==null)){
    alert("S0/SG를 모두 채워 주세요."); return;
  }
  const sol = inferKU_STRICT([f.s0.hp,f.s0.atk,f.s0.def,f.s0.agi], f.sg);
  if(!sol){ alert("계산할 수 없는 값입니다(STRICT 해 없음)."); return; }

  $("ku_k").value   = sol.k;
  $("ku_hp").value  = sol.u.hp;
  $("ku_atk").value = sol.u.atk;
  $("ku_def").value = sol.u.def;
  $("ku_agi").value = sol.u.agi;
  $("ovr_check").checked = true;

  updateConsistency();
  alert(`추정 완료: k=${sol.k}, u=(${sol.u.hp},${sol.u.atk},${sol.u.def},${sol.u.agi})`);
});

["ovr_check","ku_k","ku_hp","ku_atk","ku_def","ku_agi","s0_hp","s0_atk","s0_def","s0_agi","sg_hp","sg_atk","sg_def","sg_agi"]
  .forEach(id => $(id).addEventListener("input", updateConsistency));

$("btnClearKU").addEventListener("click", ()=>{
  $("ovr_check").checked = false;
  $("ku_k").value = $("ku_hp").value = $("ku_atk").value = $("ku_def").value = $("ku_agi").value = "";
  updateConsistency();
});

$("btnSave").addEventListener("click", ()=>{
  const f = gatherForm();

  if(!f.name){ alert("이름을 입력하세요."); return; }
  if([f.s0.hp,f.s0.atk,f.s0.def,f.s0.agi].some(v=>v==null) ||
     [f.sg.hp,f.sg.atk,f.sg.def,f.sg.agi].some(v=>v==null)){
   alert("S0/SG를 모두 채워 주세요."); return;
  }
  if(f.ovr){
    if(!(Number.isFinite(f.k) && f.u && [f.u.hp,f.u.atk,f.u.def,f.u.agi].every(Number.isFinite))){
      alert("오버라이드 k/u를 모두 채워 주세요."); return;
    }
  }
  if(CURRENT && CURRENT !== f.name){
    if(DB[f.name]){ alert("해당 이름은 이미 존재합니다."); return; }
    DB[f.name] = DB[CURRENT];
    delete DB[CURRENT];
    CURRENT = f.name;
  }
  const row = DB[f.name] || {};
  row.s0 = f.s0; row.sg = f.sg; row.note = f.note || undefined;
  if(f.ovr){ row.k=f.k; row.u=f.u; row.ku_override=true; }
  else { delete row.k; delete row.u; delete row.ku_override; }
  DB[f.name] = row;
  sortNames(); renderList(); loadForm(f.name);
  saveLS();
  alert("저장(브라우저) 완료. 커밋하려면 상단 버튼을 사용하세요.");
});

$("btnSaveCommit").addEventListener("click", async ()=>{
  $("btnSave").click();
  await commitPets();
});

$("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(DB, null, 2)], {type:"application/json;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "pets.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

$("btnCommit").addEventListener("click", commitPets);

async function commitPets(){
  const token = prompt("GitHub Personal Access Token 입력(권한: repo, contents)");
  if(!token){ alert("토큰이 필요합니다."); return; }

  const metaUrl = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(PETS_PATH)}?ref=${GH_BRANCH}`;
  const metaRes = await fetch(metaUrl, {headers:{Accept:"application/vnd.github+json"}});
  if(!metaRes.ok){ alert("원격 SHA 조회 실패: " + metaRes.status); return; }
  const meta = await metaRes.json();
  const sha = meta.sha;

  const putRes = await fetch(metaUrl, {
    method:"PUT",
    headers:{
      "Authorization":`Bearer ${token}`,
      "Accept":"application/vnd.github+json",
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      message: prompt("커밋 메시지 입력", "chore(admin): update pets.json (manual ku override)") || "update pets.json",
      content: btoa(unescape(encodeURIComponent(JSON.stringify(DB, null, 2)))),
      branch: GH_BRANCH,
      sha
    })
  });
  if(!putRes.ok){ 
    const t = await putRes.text().catch(()=>"(no body)");
    alert("커밋 실패: " + putRes.status + "\n" + t);
    return;
  }
  alert("pets.json 커밋 성공!");
}

/* ====== R8 UI ====== */
function renderR8List(){
  const box = $("r8List");
  box.innerHTML = "";
  ORDER.forEach(n=>{
    const r = DB[n]||{};
    const hasKU = Number.isFinite(r?.k) && r?.u && [r.u.hp,r.u.atk,r.u.def,r.u.agi].every(Number.isFinite);

    const lab = document.createElement('label');
    lab.className = "r8item" + (hasKU ? "" : " disabled");

    const cb = document.createElement('input');
    cb.type = "checkbox"; cb.value = n; cb.disabled = !hasKU;
    lab.appendChild(cb);

    const nameSpan = document.createElement('span'); nameSpan.className = "name"; nameSpan.textContent = n;
    lab.appendChild(nameSpan);

    const extra = document.createElement('span'); extra.className = "extra";
    if(r?.ku_override){ const tag = document.createElement('span'); tag.className="tag warn"; tag.textContent="override"; extra.appendChild(tag); }
    if(!hasKU){ const tag = document.createElement('span'); tag.className="tag"; tag.textContent="k/u 없음"; extra.appendChild(tag); }
    lab.appendChild(extra);

    box.appendChild(lab);
  });
}

$("btnR8SelectAll").addEventListener("click", ()=>{
  document.querySelectorAll("#r8List input[type=checkbox]:not(:disabled)").forEach(cb=>cb.checked=true);
});
$("btnR8ClearAll").addEventListener("click", ()=>{
  document.querySelectorAll("#r8List input[type=checkbox]").forEach(cb=>cb.checked=false);
});

$("btnR8Run").addEventListener("click", async ()=>{
  const picks = Array.from(document.querySelectorAll("#r8List input[type=checkbox]:checked")).map(cb=>cb.value);
  if(picks.length===0){ alert("대상을 선택하세요."); return; }

  R8_RESULT = {};
  const skipped = [];
  const started = performance.now();

  for(const name of picks){
    const row = DB[name];
    if(!(Number.isFinite(row?.k) && row?.u)){ skipped.push({name,reason:"k/u 없음"}); continue; }
    const sets = collectR8ObsForKU(row.k, row.u);
    R8_RESULT[name] = sets || [];
  }
  const ms = Math.round(performance.now()-started);
  const totalSets = Object.values(R8_RESULT).reduce((a,arr)=>a+(arr?.length||0),0);

  const pre = $("r8Preview");
  pre.style.display="block";
  pre.className = "callout";
  pre.innerHTML = `
    <div><b>집계 완료</b> — 대상 ${picks.length}종, 결과 총 <b>${totalSets}</b> 세트, 시간 ${ms}ms</div>
    ${skipped.length? `<div style="margin-top:6px" class="muted">스킵: ${skipped.map(s=>`${s.name}(${s.reason})`).join(', ')}</div>` : ''}
    <details style="margin-top:8px"><summary>상세 미리보기</summary>
      ${Object.keys(R8_RESULT).length===0 ? '<div class="muted">없음</div>' : `
        <table class="table" style="margin-top:8px">
          <thead><tr><th>이름</th><th>세트 수</th><th>예시</th></tr></thead>
          <tbody>
            ${Object.entries(R8_RESULT).map(([n,arr])=>{
              const ex = (arr[0] ? `(${arr[0].join(', ')})` : '-');
              return `<tr><td>${n}</td><td>${arr.length}</td><td>${ex}</td></tr>`;
            }).join('')}
          </tbody>
        </table>
      `}
    </details>
  `;
  $("btnR8Commit").disabled = Object.keys(R8_RESULT).length===0;
});

$("btnR8Commit").addEventListener("click", async ()=>{
  if(Object.keys(R8_RESULT).length===0){ alert("먼저 집계를 실행하세요."); return; }
  const token = prompt("GitHub Personal Access Token 입력(권한: repo, contents)");
  if(!token){ alert("토큰이 필요합니다."); return; }

  const metaUrl = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(R8_PATH)}?ref=${GH_BRANCH}`;
  let remoteMap = {}; let sha = null;

  const head = await fetch(metaUrl, {headers:{Accept:"application/vnd.github+json"}});
  if(head.status===200){
    const meta = await head.json();
    sha = meta.sha;
    const text = await fetch(REMOTE_R8).then(r=>r.text());
    try{ remoteMap = JSON.parse(text); }catch{ remoteMap = {}; }
  }else if(head.status!==404){
    alert("full.json 메타 조회 실패: HTTP "+head.status); return;
  }

  const out = {...remoteMap};
  for(const [name, sets] of Object.entries(R8_RESULT)){
    const prev = (remoteMap[name]?.obs_100_rank8) || remoteMap[name] || [];
    const prevStr = new Set(prev.map(a=>a.join(',')));
    const merged = [...prev];
    sets.forEach(a=>{ const k=a.join(','); if(!prevStr.has(k)) merged.push(a); });
    out[name] = { obs_100_rank8: merged, count: merged.length };
  }

  const res = await fetch(metaUrl, {
    method:"PUT",
    headers:{
      "Authorization":`Bearer ${token}`,
      "Accept":"application/vnd.github+json",
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      message: prompt("커밋 메시지 입력", "feat(admin): update guaranteed_rank8.full.json (auto from admin)") || "update guaranteed_rank8.full.json",
      content: btoa(unescape(encodeURIComponent(JSON.stringify(out, null, 2)))),
      branch: GH_BRANCH,
      ...(sha? {sha}: {})
    })
  });
  if(!res.ok){
    const t = await res.text().catch(()=>"(no body)");
    alert("커밋 실패: " + res.status + "\n" + t);
    return;
  }
  alert("guaranteed_rank8.full.json 커밋 성공!");
});

/* ====== 데이터 로드 ====== */
async function loadRemote(){
  const obj = await fetchJSON(REMOTE_PETS);
  DB = (obj && !obj.__404__) ? obj : {};
  sortNames(); renderList();
  if(ORDER.length) loadForm(ORDER[0]);
  saveLS();
  renderR8List();
}
(async function init(){
  const local = loadLS();
  if(local && typeof local==="object"){
    DB = local;
    sortNames(); renderList();
    if(ORDER.length) loadForm(ORDER[0]);
  }
  try{
    await loadRemote();
  }catch(e){
    console.warn("원격 로드 실패, 로컬 캐시로 동작", e);
    if(!local){ DB={}; renderList(); renderR8List(); }
  }
})();
</script>
</body>
</html>
