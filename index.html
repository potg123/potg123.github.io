<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>노바서버 페트 계산기</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.6.0/decimal.min.js"></script>
<link rel="shortcut icon" href="#">
<style>
  /* 바디 레벨 플로팅 툴팁 */
  .floating-tip{
    position: fixed; z-index: 9999; max-width: 360px;
    background:#0b1320; color:#cfe1ff; border:1px solid #2b3a55;
    border-radius:10px; padding:8px 10px; font-size:12px; line-height:1.35;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    pointer-events:none; white-space:normal; word-break:keep-all;
    opacity:0; transform: translateY(4px);
    transition: opacity .12s ease, transform .12s ease;
  }
  .floating-tip.show{ opacity:1; transform: translateY(0); }
  .floating-tip::after{
    content:""; position:absolute; width:10px; height:10px; left:50%;
    transform: translateX(-50%) rotate(45deg);
    background:#0b1320; border-left:1px solid #2b3a55; border-top:1px solid #2b3a55;
  }
  .floating-tip[data-pos="top"]::after{ bottom:-5px; }
  .floating-tip[data-pos="bottom"]::after{ top:-5px; transform: translateX(-50%) rotate(225deg); }

  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#8a9099; --accent:#6aa0ff;
    --ok:#35c759; --warn:#ffb300; --bad:#ff5171; --chip:#232a36;
    --ring:#1f2530; --text:#e8ecf3; --ring-size: 60px; --ring-thickness: 10px;
    --hud-speed: 120; /* HUD 도는 속도(px/s) */
    --glow: 8px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(180deg,#0f1115 0%,#0c0f14 100%); color:var(--text);
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 20px; border-bottom:1px solid #232a36; background:rgba(0,0,0,.2);
    position:static; top:auto; z-index:10;
  }
  h1{margin:0 0 6px; font-size:18px}
  .brand{font-weight:700; letter-spacing:.3px}
  .ver{color:var(--muted); font-size:12px; display:flex; align-items:center; gap:10px}
  .grid{ max-width:1100px; margin:20px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--panel); border:1px solid #232a36; border-radius:14px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25);}
  .card h3{margin:4px 0 12px 0; font-size:16px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .col{flex:1 1 0}
  label{display:block; font-size:12px; color:var(--muted); margin:6px 0 4px 2px}
  input[type="number"], input[type="text"]{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3040;
    background:#0e1218; color:var(--text); outline:none;
  }
  input[readonly]{opacity:.7; cursor:not-allowed}
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .btn{ padding:10px 14px; border-radius:10px; border:1px solid #334055; cursor:pointer; background:#142033; color:#cfe1ff; font-weight:600; }
  .btn:hover{filter:brightness(1.1)}
  .btn.primary{ background:linear-gradient(180deg,#2b71ff,#1d56cc); border-color:transparent; color:white;}
  .btn.ghost{ background:transparent; text-decoration: none;}
  .btn-sm{padding:6px 10px; font-size:12px; border-radius:8px}
  .muted{color:var(--muted); font-size:12px}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{ background:var(--chip); color:#cfd6e3; border:1px solid #2b3242; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer; }
  .chip.on{outline:2px solid var(--accent)}
  .kbd{display:inline-block; border:1px solid #404a5e; border-bottom-width:3px; padding:2px 6px; border-radius:6px; background:#0e131a; font-weight:700}
  .chooser{display:grid; grid-template-columns: 1fr; gap:8px}
  .list{ max-height:260px; overflow:auto; border:1px solid #2a3040; border-radius:10px; padding:6px; background:#0d1117; }
  .item{padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition: background .12s ease, outline-color .12s ease; font-size:12px;}
  .item:hover{background:#19202b}
  .item.selected{ background:#1b2535; outline:2px solid #30518d; }
  .tags{display:flex; gap:6px; align-items:center}
  .tag{font-size:11px;border:1px solid #2b3242;border-radius:999px;padding:2px 8px}
  .tag.ok{border-color:#275a34; background:#102214; color:#35c759}
  .tag.warn{border-color:#7a5b0e; background:#241a05; color:#ffb300}
  .tag.rank8{border-color:#2b4a82; background:#0d1a33; color:#88b5ff}
    /* ★ 즐겨찾기 배지 */
  .tag.fav{cursor:pointer; user-select:none}
  .tag.fav.on{border-color:#6a5600; background:#221c05; color:#ffd24a}
  .kpis{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}

  @media (max-width: 720px){ .kpis{grid-template-columns: 1fr} }
  .kpi{ display:flex; gap:14px; align-items:center; border:1px solid #2a3040; border-radius:14px; padding:14px; background:radial-gradient(120px 120px at 20% -10%, #11224444, transparent); }
  .ringwrap{ position:relative; width:var(--ring-size); height:var(--ring-size); flex:0 0 var(--ring-size); }
  svg{ display:block; width:100%; height:100%; }
  .track{ stroke: var(--ring); fill:none; stroke-linecap: round; }
  .fill { stroke: var(--accent); fill:none; stroke-linecap: round; transition: stroke .25s ease, stroke-dashoffset .25s linear; }

  /* 성공 링 HUD */
  .hud { filter: drop-shadow(0 0 var(--glow) rgba(160,200,255,.6)); }
  .tail{ stroke: #9fc3ff; stroke-linecap: round; opacity:.7; fill:none; }
  .core{ stroke: #fff;     stroke-linecap: round; fill:none; }
  .flare{ fill: #fff; opacity:.95; }
  /* 도넛(기본 게이지) — 크기 고정 + 마스크로 속빈 원 */
  .ring{
    width: var(--ring-size);
    height: var(--ring-size);
    flex: 0 0 var(--ring-size);
    position: relative;
    border-radius: 50%;
    overflow: hidden;
    isolation: isolate;
    --p: 0deg; /* JS에서 진행각 설정 */
    background: conic-gradient(var(--accent) 0 var(--p), var(--ring) 0);
  /* 속 비우기(도넛) 마스크 */
    -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - var(--ring-thickness)), #000 0);
          mask: radial-gradient(farthest-side, transparent calc(100% - var(--ring-thickness)), #000 0);
  }


  /* ★ 성공 링에만 HUD 스윕 */
  #ringSuccess::after{
    content:"";
    position:absolute; inset:0;
    border-radius:50%;
    pointer-events:none;
    opacity: calc(var(--sweep-on, 0) * var(--sweep-opacity)); /* 진행 0%면 완전 숨김 */
    filter: blur(var(--sweep-blur));
    will-change: transform;
    animation: ring-sweep var(--sweep-speed) linear infinite;
  /* 얇은 빛 웨지 패턴 */
    background:
      repeating-conic-gradient(
        from -90deg,
        rgba(255,255,255,0)   0deg 6deg,
        rgba(255,255,255,.9)  6deg 7.2deg,
        rgba(255,255,255,0)  7.2deg 14.4deg
      );
  /* (1) 도넛 모양으로 구멍 + (2) 진행각까지만 표시 */
    -webkit-mask-image:
      radial-gradient(farthest-side, transparent calc(100% - var(--ring-thickness)), #000 0),
      conic-gradient(#000 0 calc(var(--p) + .0001deg), transparent 0); /* 0deg 버그회피용 +ε */
    -webkit-mask-composite: source-in;
          mask-image:
      radial-gradient(farthest-side, transparent calc(100% - var(--ring-thickness)), #000 0),
      conic-gradient(#000 0 calc(var(--p) + .0001deg), transparent 0);
          mask-composite: intersect;
  }

  @keyframes ring-sweep{ to { transform: rotate(360deg); } }

/* (선택) 숫자 폭 고정해서 레이아웃 흔들림 방지 */
  #kpiSuccess, #kpiAppear{ display:inline-block; min-width: 9ch; font-variant-numeric: tabular-nums; }
  #kpiTries{   display:inline-block; min-width: 6ch; font-variant-numeric: tabular-nums; }

  .kpi strong{font-size:20px; color:var(--highlight)}
  .kpi small{display:block; color:var(--muted)}
  .table{width:100%; border-collapse:collapse; font-size:13px}
  .table th,.table td{border-bottom:1px solid #262d3a; padding:8px 6px; text-align:right}
  .table th:first-child,.table td:first-child{text-align:left}
  .badge{display:inline-block; min-width:34px; font-size:12px; text-align:center; padding:2px 6px; border-radius:6px; background:#223; border:1px solid #356}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .footer{max-width:1100px; margin:8px auto 30px; padding:0 16px; color:var(--muted); font-size:12px}
  .imgbox{width:100%; aspect-ratio: 16/9; border:1px dashed #334055; border-radius:12px; display:grid; place-items:center; background:#0d1117; overflow:hidden;}
  .imgbox img{width:100%; height:100%; object-fit:cover; display:block}
  .stepper{display:flex; gap:6px; margin-top:6px}
    /* 숫자 자릿수 고정 + 등폭 숫자 */
  #kpiSuccess, #kpiAppear{
    display:inline-block;
    min-width: 9ch;               /* "100.0000%" 정도를 수용 */
    font-variant-numeric: tabular-nums;
  }
  #kpiTries{
    display:inline-block;
    min-width: 6ch;               /* "123.45" 정도 */
    font-variant-numeric: tabular-nums;
  }
  
/* === Toast === */
  .toastWrap{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; font-size:12px; z-index:9999}
  .toast{background:#101826; border:1px solid #2a3a59; color:#cfe3ff; padding:10px 12px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.3); opacity:0; transform:translateY(10px); transition: all .25s ease }
  .toast.show{opacity:1; transform:translateY(0)}

  #petList {
    max-height: calc(5 * 40px);
    overflow-y: auto;
  }
</style>
</head>
<body>
<header>
  <div class="title">
    <h1>노바서버 페트 계산기</h1>
    <div class="muted">패치노트 v2.5 적용</div>
  </div>
    <div class="ver">
      <a class="btn ghost" id="btnDict" href="./petsfilter.html">페트사전</a>
      <a class="btn ghost" id="btnSimulator" href="./simulator.html">초구시뮬</a>
      <button class="btn ghost" id="btnAdmin">관리자</button>
    </div>
</header>

<div class="grid">
  <!-- 좌: 펫 선택 -->
  <section class="card">
    <h3>① 페트 선택</h3>
    <div class="row">
      <div class="col chooser">
        <label>초성 키패드</label>
        <div id="chosung" class="chips"></div>

        <div class="row" style="margin-top:6px; align-items:center">
          <span class="muted" style="min-width:78px">선택한 초성</span>
          <div id="chosungTokens" class="chips" style="min-height:28px"></div>
        </div>

        <!-- ★ 즐겨찾기 바 -->
        <div class="row" style="margin-top:6px; align-items:center">
          <span class="muted" style="min-width:78px">즐겨찾기<br>(최대 5개)</span>
          <div id="favChips" class="chips" style="min-height:28px"></div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col">
            <input type="text" id="petSearch" placeholder="검색어를 입력해 주세요." />
          </div>
          <button class="btn" id="btnClear">지우기</button>
        </div>
        <div class="list" id="petList"></div>
      </div>
    </div>
    <p class="muted" style="margin-top:8px">팁: 초성만 눌러도 후보가 빠르게 걸러집니다. (예: 반기노 = <span class="kbd">ㅂ</span>→<span class="kbd">ㄱ</span>)</p>
  </section>

  <!-- 우: 표기 S0 / Sg + 관측 입력 -->
  <section class="card">
    <h3>② 페트 초기치 입력</h3>

    <div class="row">
      <div class="col">
        <label>S급 초기치 (체/공/방/순)</label>
        <div class="row">
          <div class="col"><input type="number" id="s0_hp"  step="0.01" readonly /></div>
          <div class="col"><input type="number" id="s0_atk" step="0.01" readonly /></div>
          <div class="col"><input type="number" id="s0_def" step="0.01" readonly /></div>
          <div class="col"><input type="number" id="s0_agi" step="0.01" readonly /></div>
        </div>

        <label style="margin-top:10px">S급 성장치 (체/공/방/순)</label>
        <div class="row">
          <div class="col"><input type="number" id="sg_hp"  step="0.01" readonly /></div>
          <div class="col"><input type="number" id="sg_atk" step="0.01" readonly /></div>
          <div class="col"><input type="number" id="sg_def" step="0.01" readonly /></div>
          <div class="col"><input type="number" id="sg_agi" step="0.01" readonly /></div>
        </div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #2a3040; margin:14px 0" />

    <div class="row">
      <div class="col">
        <label>1레벨 초기치 (체/공/방/순)</label>
        <div class="row">
          <div class="col">
            <input type="number" id="obs_hp"  step="1" min="1" max="100" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_hp" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_hp" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_atk" step="1" min="1" max="100" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_atk" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_atk" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_def" step="1" min="1" max="100" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_def" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_def" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_agi" step="1" min="1" max="100" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_agi" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_agi" data-delta="1">+1</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnCalc">계산</button>
      <button class="btn ghost" id="btnReset">리셋</button>
      <span class="muted" style="margin-left:auto">스크롤 업/다운으로 수치 조정 가능</span>
    </div>
  </section>

<!-- 좌하단: KPI 강조 -->
<section class="card" id="resultCard">
<h3>③ 결과</h3>
<div class="kpis">
<!-- 성공 확률 -->
<div class="kpi">
<div class="ringwrap">
<svg viewBox="0 0 100 100" aria-hidden="true">
<defs>
<circle id="succPath" cx="50" cy="50" r="45"/>
<mask id="succMask" maskUnits="userSpaceOnUse">
<circle id="succMaskStroke" cx="50" cy="50" r="45"
fill="none" stroke="#fff" stroke-width="10" stroke-linecap="round"
transform="rotate(-90 50 50)"

stroke-dasharray="0 1" stroke-dashoffset="0"/>
</mask>
</defs>

<use href="#succPath" class="track" stroke-width="10" transform="rotate(-90 50 50)"/>
<use id="succFill" href="#succPath" class="fill" stroke-width="10"
transform="rotate(-90 50 50)" stroke-dasharray="0 1" stroke-dashoffset="0" style="stroke: none;"/>

<!-- HUD 이펙트(성공 링에만) -->
<g id="succHUD" class="hud" mask="url(#succMask)" style="opacity: 0;">
<path id="succTail" class="tail" stroke-width="10"/>
<path id="succCore" class="core" stroke-width="6"/>
<circle id="succFlare" class="flare" r="3" cx="50" cy="5"/>
</g>
</svg>
</div>

<div>
<strong id="kpiSuccess">0.0000%</strong>
<small>8등급(환각) 확률</small>
</div>
</div>

<!-- 출현 확률 -->

<div class="kpi">
<div class="ringwrap">
<svg viewBox="0 0 100 100" aria-hidden="true">
<circle id="apPath" cx="50" cy="50" r="43" fill="none"/>
<use href="#apPath" class="track" stroke-width="10" transform="rotate(-90 50 50)"/>
<use id="apFill" href="#apPath" class="fill" stroke="#7fd4ff" stroke-width="10"
transform="rotate(-90 50 50)" stroke-dasharray="0 1" stroke-dashoffset="0" style="stroke: none;"/>
</svg>
</div>

<div>
<strong id="kpiAppear">0.000000%</strong>
<span id="apBadge" class="badge" style="display:none">2% ↑</span>

<small>출현 확률</small>
</div>
</div>

<!-- 성공 기대값 (200↑ 항상 100%) -->

<div class="kpi">
<div class="ringwrap">
<svg viewBox="0 0 100 100" aria-hidden="true">
<circle id="trPath" cx="50" cy="50" r="43" fill="none"/>
<use href="#trPath" class="track" stroke-width="10" transform="rotate(-90 50 50)"/>
<use id="trFill" href="#trPath" class="fill" stroke="#999" stroke-width="10"
transform="rotate(-90 50 50)" stroke-dasharray="0 1" stroke-dashoffset="0" style="stroke: none;"/>
</svg>
</div>
        <div>
          <strong id="kpiTries">0회</strong>
          <small style="white-space: nowrap;">기대 시도 횟수</small>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="row">
        <div class="col"><span class="muted">총 매칭 :</span> <span class="badge" id="totMatches">0</span></div>
        <div class="col"><span class="muted">환각 매칭 :</span> <span class="badge" id="rank8Matches">0</span></div>
        <div class="col"><span class="muted">전수값 :</span> <span class="badge">178,750</span></div>
      </div>
    </div>

<div id="dist" style="margin-top:12px"></div>
  </section>

  <!-- 우하단: 이미지 공간 -->
  <section class="card">
    <div class="imgbox">
      <img src="https://raw.githubusercontent.com/potg123/potg123.github.io/main/nova.png" alt="StoneAge Nova" loading="lazy" decoding="async"/>
    </div>
    <p class="muted" style="margin-top:8px">이 계산기는 짜얄 계산기 데이터 계수 기반으로 제작되었습니다. </p>
  </section>
</div>

<div class="footer">
  <p>· “환각(8등급)”은 베이스 합계가 <b>+8</b>인 경우만 집계합니다. (베이스 각 항목 범위 −2..+2, 보너스 총합 10 분배)</p>
</div>

  <!-- ★ 토스트 컨테이너 -->
<div class="toastWrap" id="toastWrap"></div>

<script>
/* ========= 서버 경로 ========= */ 
const LOCAL_PETS = "data/pets.json";
const GH_OWNER  = "potg123";
const GH_REPO   = "potg123.github.io";
const GH_BRANCH = "main";
const PETS_PATH = "data/pets.json";
const REMOTE_PETS = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${PETS_PATH}`;

/* ========= Rank8 JSON (우선순위 로드) ========= */
const R8_JSON_CANDIDATES = [
  "data/guaranteed_rank8.full.json",
  "data/guaranteed_rank8.min.json",
  "guaranteed_rank8.sample8.json"
];

/* ========= 상수 ========= */
const LS_TABLE = "novaPetTable_cache";
const TOTAL = 178750;

/* ========= 즐겨찾기 ========= */
const FAV_LS_KEY = "pet_favs_v1";
let FAVS = [];
function loadFavs(){
  try{
    const arr = JSON.parse(localStorage.getItem(FAV_LS_KEY)||"[]");
    return Array.isArray(arr) ? arr.filter(x=>typeof x==="string").slice(0,5) : [];
  }catch{ return []; }
}
function saveFavs(){ localStorage.setItem(FAV_LS_KEY, JSON.stringify(FAVS)); }
function isFav(name){ return FAVS.includes(name); }
function showToast(msg, ms=1500){
  const wrap = document.getElementById("toastWrap");
  const t = document.createElement("div");
  t.className = "toast"; t.textContent = msg;
  wrap.appendChild(t);
  void t.offsetWidth; t.classList.add("show");
  setTimeout(()=>{ t.classList.remove("show"); setTimeout(()=>wrap.removeChild(t), 250); }, ms);
}
function renderFavChips(){
  const box = document.getElementById("favChips");
  if(!box) return;
  box.innerHTML = "";
  if(FAVS.length===0){
    const span = document.createElement("span"); span.className="muted";
    box.appendChild(span); return;
  }
  FAVS.forEach(n=>{
    const c = document.createElement("div");
    c.className="chip"; c.textContent=n; c.title=`${n} 선택`;
    c.addEventListener("click", ()=>{
      // 필터 초기화 후 해당 펫 선택
      petSearch.value=""; currentChosung="";
      Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
      renderPetList();
      const items = Array.from(petList.children);
      const el = items.find(div => div.firstChild && div.firstChild.textContent === n);
      if(el){ el.click(); el.scrollIntoView({block:'nearest'}); }
    });
    box.appendChild(c);
  });
}
function addFav(name){
  if(isFav(name)) return;
  if(FAVS.length >= 5){ showToast("즐겨찾기는 최대 5개까지 가능합니다."); return; }
  FAVS.push(name); saveFavs(); renderFavChips(); renderPetList(); showToast("즐겨찾기에 추가되었습니다.");
}
function removeFav(name){
  const i = FAVS.indexOf(name);
  if(i>=0){ FAVS.splice(i,1); saveFavs(); renderFavChips(); renderPetList(); showToast("즐겨찾기에 삭제되었습니다."); }
}
function toggleFav(name){ isFav(name) ? removeFav(name) : addFav(name); }

/* ========= 전역 ========= */
let GLOBAL_TABLE = {};
let ALL_NAMES = [];
let R8MAP = {}; // name -> {count, obs_100_rank8: [[hp,atk,def,agi],...]}

/* ========= 유틸 ========= */
function getJSONLS(key, fallback={}){ try{ return JSON.parse(localStorage.getItem(key)||JSON.stringify(fallback)); }catch{ return fallback; } }
function setJSONLS(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function fetchJSON(url){ return fetch(url+`?v=${Date.now()}`,{cache:"no-store"}).then(r=>{ if(!r.ok) throw 0; return r.json();}); }
function fmtPct(x){
  if(!Number.isFinite(x)) return "—%";
  if(x === 0) return "0.0000%";
  if(x < 0.001) return x.toFixed(6) + "%";
  return x.toFixed(4) + "%";
}

/* ========= 초성(문자 → 초성) 유틸 ========= */
const CHO_CODE = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
const CHO_SIMPLE = (c)=>({"ㄲ":"ㄱ","ㄸ":"ㄷ","ㅃ":"ㅂ","ㅆ":"ㅅ","ㅉ":"ㅈ"}[c]||c);
function getChosung(str){
  let out="";
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code<0xAC00 || code>0xD7A3){ out+=ch; continue; }
    const idx = Math.floor((code - 0xAC00) / 588);
    out += CHO_SIMPLE(CHO_CODE[idx]);
  }
  return out;
}

/* ========= 원격 로드 ========= */
async function loadGlobalTable(){
  try{
    // 1차: raw.githubusercontent 경로
    const obj = await fetchJSON(REMOTE_PETS);
    if(typeof obj!=="object" || Array.isArray(obj)) throw 0;
    GLOBAL_TABLE = obj; setJSONLS(LS_TABLE, obj);
  }catch{
    try{
      // 2차: 같은 도메인의 /data/pets.json (깃허브 페이지/로컬 호환)
      const obj = await fetchJSON(LOCAL_PETS);
      if(typeof obj!=="object" || Array.isArray(obj)) throw 0;
      GLOBAL_TABLE = obj; setJSONLS(LS_TABLE, obj);
    }catch{
      // 3차: 로컬스토리지 캐시
      GLOBAL_TABLE = getJSONLS(LS_TABLE, {});
      console.warn("[pets] remote/local 모두 실패 → localStorage 캐시 사용");
    }
  }
  ALL_NAMES = Object.keys(GLOBAL_TABLE).sort((a,b)=>a.localeCompare(b,'ko'));
  
  // 즐겨찾기 검증(없는 이름 제거)
  FAVS = FAVS.filter(n => GLOBAL_TABLE[n]);
  saveFavs();
  renderFavChips();
}
async function loadRank8Map(){
  for(const path of R8_JSON_CANDIDATES){
    try{
      const m = await fetchJSON(path);
      if (typeof m==="object" && !Array.isArray(m)){
        R8MAP = m;
        console.log("[Rank8] loaded:", path, "keys:", Object.keys(R8MAP).length);
        return;
      }
    }catch{ /* try next */ }
  }
  R8MAP = {};
  console.log("[Rank8] no file found; badge disabled");
}

/* ========= DOM ========= */
const chosungBar = document.getElementById('chosung');
const chosungTokens = document.getElementById('chosungTokens');
const petList = document.getElementById('petList');
const petSearch = document.getElementById('petSearch');

const s0hp = document.getElementById('s0_hp');
const s0atk= document.getElementById('s0_atk');
const s0def= document.getElementById('s0_def');
const s0agi= document.getElementById('s0_agi');

const sghp = document.getElementById('sg_hp');
const sgatk= document.getElementById('sg_atk');
const sgdef= document.getElementById('sg_def');
const sgagi= document.getElementById('sg_agi');

const obshp = document.getElementById('obs_hp');
const obsatk= document.getElementById('obs_atk');
const obsdef= document.getElementById('obs_def');
const obsagi= document.getElementById('obs_agi');

const kpiSuccess = document.getElementById('kpiSuccess');
const kpiAppear  = document.getElementById('kpiAppear');
const kpiTries   = document.getElementById('kpiTries');
const distBox = document.getElementById('dist');

const btnCalc = document.getElementById('btnCalc');
const btnReset= document.getElementById('btnReset');
const btnClear= document.getElementById('btnClear');

let currentChosung="";
let selectedName=null;
let selectedRow=null;
let selectedItemEl=null; // 선택 하이라이트 유지

// ===== 바디 레벨 툴팁 =====
const tipEl = document.createElement('div');
tipEl.className = 'floating-tip';
document.body.appendChild(tipEl);
let tipTimer = null;

function hideTip(){ tipEl.classList.remove('show'); }
function showTip(target){
  const text = target.getAttribute('data-tip');
  if(!text){ hideTip(); return; }
  const lines = String(text).split('\n');
  tipEl.textContent = '';
  lines.forEach((line,i)=>{
    tipEl.appendChild(document.createTextNode(line));
    if(i < lines.length-1) tipEl.appendChild(document.createElement('br'));
  });
  tipEl.classList.add('show');
  tipEl.style.left = '-9999px'; tipEl.style.top  = '-9999px'; tipEl.removeAttribute('data-pos');
  tipEl.getBoundingClientRect();
  const rect = target.getBoundingClientRect();
  const tw = tipEl.offsetWidth, th = tipEl.offsetHeight;
  const margin = 8;
  let pos = 'top';
  let left = rect.left + rect.width/2 - tw/2;
  left = Math.max(8, Math.min(left, window.innerWidth - tw - 8));
  let top = rect.top - th - margin;
  if(top < 6){ top = rect.bottom + margin; pos = 'bottom'; }
  tipEl.dataset.pos = pos;
  tipEl.style.left = `${Math.round(left)}px`;
  tipEl.style.top  = `${Math.round(top)}px`;
}
petList.addEventListener('mouseover', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; showTip(t);
}, true);
petList.addEventListener('mouseout', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; hideTip();
}, true);
petList.addEventListener('focusin', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; showTip(t);
});
petList.addEventListener('focusout', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; hideTip();
});
petList.addEventListener('touchstart', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; e.stopPropagation(); showTip(t);
  clearTimeout(tipTimer); tipTimer = setTimeout(hideTip, 1800);
}, {passive:true});
window.addEventListener('scroll', hideTip, true);
window.addEventListener('resize', hideTip);

/* ===== 관리자 버튼 ===== */
document.getElementById('btnAdmin').addEventListener('click', ()=>{
  location.href = "./admin.html";
});

/* ========= 초성 키패드 ========= */
const CHO = ['ㄱ','ㄴ','ㄷ','ㄹ','ㅁ','ㅂ','ㅅ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];

function renderChosungTokens(){
  chosungTokens.innerHTML = "";
  for(const ch of currentChosung){
    const t = document.createElement('div');
    t.className = 'chip'; t.style.cursor = 'default'; t.textContent = ch;
    chosungTokens.appendChild(t);
  }
}
CHO.forEach(c=>{
  const chip=document.createElement('div');
  chip.className='chip'; chip.textContent=c;
  chip.addEventListener('click', ()=>{
    currentChosung += c;
    renderPetList();
    renderChosungTokens();
    Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
    chip.classList.add('on');
  });
  chosungBar.appendChild(chip);
});
petSearch.addEventListener('input', renderPetList);

/* ========= 목록 ========= */
function renderPetList(){
  const kw = (petSearch.value||"").trim();
  const names = ALL_NAMES.length? ALL_NAMES : Object.keys(GLOBAL_TABLE);
  const list = names.filter(n=>{
    const a = kw? n.includes(kw): true;
    const b = currentChosung? getChosung(n).startsWith(currentChosung): true;
    return a && b;
  });

  petList.innerHTML="";
  if(list.length===0){
    const d=document.createElement('div'); d.className='item'; d.textContent='결과 없음';
    petList.appendChild(d);
    return;
  }

  list.forEach(n=>{
    const div=document.createElement('div'); div.className='item';

    const left=document.createElement('div'); left.textContent = n;
    const right=document.createElement('div'); right.className="tags";

    // 8등급 보장 배지
    const r8 = R8MAP[n];
    if (r8 && (Array.isArray(r8.obs_100_rank8) ? r8.obs_100_rank8.length : (r8.length||0))) {
      const sets = Array.isArray(r8.obs_100_rank8) ? r8.obs_100_rank8 : r8;
      const tag2 = document.createElement('span');
      tag2.className = 'tag rank8 tip';
      tag2.textContent = '100%';

      const maxShow = 20;
      const preview = sets.slice(0, maxShow).map(a=>`(${a[0]},${a[1]},${a[2]},${a[3]})`).join(' · ');
      const more = sets.length>maxShow ? ` 외 ${sets.length-maxShow}세트` : '';
      const tipText = `8등급 보장 초기치\n${preview}${more}`;
      tag2.setAttribute('data-tip', tipText);

      tag2.tabIndex = 0;
      const stop = (e)=>{ e.stopPropagation(); };
      tag2.addEventListener('click', stop);
      tag2.addEventListener('touchstart', stop, {passive:true});

      right.appendChild(tag2);
    }

    /* ★ 즐겨찾기 별 배지 */
    const star = document.createElement('span');
    const favOn = isFav(n);
    star.className = 'tag fav' + (favOn ? ' on' : '');
    star.textContent = favOn ? '즐겨찾기' : '즐겨찾기';
    star.title = favOn ? '즐겨찾기 삭제' : '즐겨찾기 추가';
    star.setAttribute('role','button');
    star.setAttribute('aria-pressed', favOn ? 'true' : 'false');
    star.tabIndex = 0;
    const toggle = (e)=>{ e.stopPropagation(); toggleFav(n); };
    star.addEventListener('click', toggle);
    star.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ toggle(e); }});
    right.appendChild(star);

    div.appendChild(left);
    div.appendChild(right);
    div.addEventListener('click', ()=>{
      if(selectedItemEl) selectedItemEl.classList.remove('selected');
      div.classList.add('selected');
      selectedItemEl = div;
      selectPetName(n);
    });
    if (n === selectedName) { div.classList.add('selected'); selectedItemEl = div; }
    petList.appendChild(div);
  });

  renderChosungTokens();
}

/* ========= 펫 선택 ========= */
function selectPetName(n){
selectedName=n;
selectedRow=GLOBAL_TABLE[n]||null;

if(selectedRow?.s0){
s0hp.value=selectedRow.s0.hp??""; s0atk.value=selectedRow.s0.atk??"";
s0def.value=selectedRow.s0.def??""; s0agi.value=selectedRow.s0.agi??"";
}else{ s0hp.value=s0atk.value=s0def.value=s0agi.value=""; }

if(selectedRow?.sg){
sghp.value=selectedRow.sg.hp??""; sgatk.value=selectedRow.sg.atk??"";
sgdef.value=selectedRow.sg.def??""; sgagi.value=selectedRow.sg.agi??"";
}else{ sghp.value=sgatk.value=sgdef.value=sgagi.value=""; }

if(selectedRow?.s0){
obshp.value = Math.floor(selectedRow.s0.hp??NaN)||"";
obsatk.value= Math.floor(selectedRow.s0.atk??NaN)||"";
obsdef.value= Math.floor(selectedRow.s0.def??NaN)||"";
obsagi.value= Math.floor(selectedRow.s0.agi??NaN)||"";
}else{
obshp.value=obsatk.value=obsdef.value=obsagi.value="";
}
showKpis(null);
}
/* ===== 공통 유틸 ===== */
function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function resolveR(el){
const rSelf = parseFloat(el.getAttribute('r'));
if (isFinite(rSelf)) return rSelf;
const href = el.getAttribute('href') || el.getAttribute('xlink:href');
if (href && href[0]==='#'){
const ref = el.ownerSVGElement.getElementById(href.slice(1));
const rr = parseFloat(ref && ref.getAttribute('r'));
if (isFinite(rr)) return rr;
}
return 45;
}
function makeRing(fillEl, maskStrokeEl, colorGetter){
const r = resolveR(fillEl);
const C = 2 * Math.PI * r;
const baseStroke = fillEl.style.stroke || fillEl.getAttribute('stroke') || '#fff';
const strokeOn = (col)=>{ fillEl.style.stroke = col || (colorGetter? colorGetter(): baseStroke); };
const strokeOff = ()=>{ fillEl.style.stroke = 'none'; };
const clamp01 = (x)=> (Number.isFinite(x)? Math.max(0, Math.min(1,x)) : 0);

function setFrac(frac){
const f = clamp01(frac);
if (f === 0){
fillEl.setAttribute('stroke-dasharray','0 1');
fillEl.setAttribute('stroke-dashoffset','0');
if(maskStrokeEl){
maskStrokeEl.setAttribute('stroke-dasharray','0 1');
maskStrokeEl.setAttribute('stroke-dashoffset','0');
}
strokeOff();
return;
}
const dash=C, gap=C, off=(1-f)*C;
fillEl.setAttribute('stroke-dasharray', `${dash} ${gap}`);
fillEl.setAttribute('stroke-dashoffset', `${off}`);
if(maskStrokeEl){
maskStrokeEl.setAttribute('stroke-dasharray', `${dash} ${gap}`);
maskStrokeEl.setAttribute('stroke-dashoffset', `${off}`);
}
strokeOn();
}
return { setFrac, C };
}
function polar0(cx,cy,r,deg){ const t=deg*Math.PI/180; return [cx + r*Math.cos(t), cy + r*Math.sin(t)]; }
function arcPath0(cx,cy,r,deg0,deg1){
let s=deg0, e=deg1; while(e<s) e+=360;
const span=e-s, large=span>180?1:0;
const [x0,y0]=polar0(cx,cy,r,s), [x1,y1]=polar0(cx,cy,r,e);
return `M ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1}`;
}

/* ===== 1) 성공% + HUD ===== */
const succFill = document.getElementById('succFill');
const succMaskStroke = document.getElementById('succMaskStroke');
const { setFrac: _succSetFrac } = makeRing(succFill, succMaskStroke, ()=>getCSS('--accent'));
const hud = document.getElementById('succHUD');
const tail= document.getElementById('succTail');
const core= document.getElementById('succCore');
const flare= document.getElementById('succFlare');
const SUCCR = resolveR(succFill);
let head=0, run=false, lastTs=0;

function tick(ts){
if(!run) return;
if(!lastTs) lastTs=ts;
const dt=(ts-lastTs)/1000; lastTs=ts;
const circum=2*Math.PI*SUCCR, pxPerSec=parseFloat(getCSS('--hud-speed'))||120;
const degPerSec=(pxPerSec/circum)*360;
head=(head + degPerSec*dt) % 360;

const TAIL_SPAN=360*0.22, CORE_SPAN=360*0.10;
tail.setAttribute('d', arcPath0(50,50,SUCCR, head-TAIL_SPAN, head));
core.setAttribute('d', arcPath0(50,50,SUCCR, head-CORE_SPAN, head));
const [fx,fy]=polar0(50,50,SUCCR, head);
flare.setAttribute('cx', fx.toFixed(2)); flare.setAttribute('cy', fy.toFixed(2));
requestAnimationFrame(tick);
}
function setSuccess(pct){
const f = Math.max(0, Math.min(100, Number(pct)||0))/100;
_succSetFrac(f);
document.getElementById('kpiSuccess').textContent = (f*100).toFixed(4) + '%';
if(f<=0){
hud.style.opacity=0; run=false; lastTs=0; head=0;
tail.setAttribute('d',''); core.setAttribute('d','');
}else{
hud.style.opacity=1; if(!run){ run=true; lastTs=0; requestAnimationFrame(tick); }
}
}
window.setSuccess = setSuccess;

/* ===== 2) 출현% — 게이지 최대 2% ===== */
const apFill = document.getElementById('apFill');
const { setFrac: _apSetFrac } = makeRing(apFill, null, ()=> '#7fd4ff');
function setAppear(pctReal){
const p = Math.max(0, Number(pctReal)||0);
const
frac = Math.min(p, 2) / 2; // 0~2% → 0~100%
_apSetFrac(frac);
document.getElementById('kpiAppear').textContent = p.toFixed(6) + '%';
document.getElementById('apBadge').style.display = (p>2 ? '' : 'none');
}
window.setAppear = setAppear;

/* ===== 3) 기대값 — 200↑ 항상 100% + 색상(초/노/빨) ===== */
const trFill = document.getElementById('trFill');
let currTries = 1; // 먼저 선언해야 함

function colorByTries(x) {
  return (x < 50) ? getCSS('--ok')      // 초록
       : (x < 100) ? getCSS('--warn')   // 노랑
       : getCSS('--bad');               // 빨강
}

const { setFrac: _trSetFrac } = makeRing(trFill, null, () => colorByTries(currTries));

function setTries(t) {
  currTries = Number(t); // ✅ 고정 1 제거

  let frac;
  if (currTries >= 200) frac = 1;
  else if (currTries <= 0) frac = 0; // ✅ 음수나 0은 0으로
  else frac = currTries / 200;

  trFill.style.stroke = colorByTries(currTries);
  _trSetFrac(frac);

  document.getElementById('kpiTries').textContent =
    (Number.isFinite(t) ? Math.round(currTries) + '회' : '—');
}

window.setTries = setTries;
/* ===== KPI 렌더 교체 =====
*/
function showKpis(res){
if(!res){
// 값 표시

kpiSuccess.textContent = "—%";
kpiAppear .textContent = "—%";
kpiTries .textContent = "—";
// 링 리셋(크기·비율 유지)
setSuccess(0);
setAppear(0);
setTries(0);
// 부가정보 리셋

totMatches.textContent = "0";
rank8Matches.textContent = "0";
distBox.innerHTML = "";
return;
}


const matches = res.matches|0;
const rank8 = res.rank8|0;
const appear = matches/TOTAL*100; // 실제 출현 %

const successPct = matches ? (rank8/matches*100) : 0; // 성공 %

const tries = successPct > 0 ?
(100/successPct) : Infinity;

// 수치 텍스트

kpiSuccess.textContent = fmtPct(successPct);
kpiAppear .textContent = fmtPct(appear);

// 링 반영
setSuccess(successPct);
setAppear(appear);
setTries(isFinite(tries) ? tries : 200); // 성공확률 0% → 200으로 고정(항상 100%)

// 요약 수치 및 분포

totMatches.textContent = matches.toLocaleString();
rank8Matches.textContent = rank8.toLocaleString();

const entries = Object.entries(res.dist)
.map(([r,c]) => ({r:parseInt(r,10), c}))
.sort((a,b) => b.r - a.r || b.c - a.c);

let html = `<table class="table"><thead><tr><th>등급(베이스합)</th><th>건수</th><th>비율</th></tr></thead><tbody>`;
const total = matches || 1;
entries.forEach(e=>{
const pct = (e.c/total*100).toFixed(2);
const cls = (e.r===8 ? "ok" : (e.r>=5 ? "warn" : ""));
html += `<tr><td class="${cls}">${e.r}</td><td>${e.c.toLocaleString()}</td><td>${pct}%</td></tr>`;
});
html += `</tbody></table>`;
distBox.innerHTML = html;
}

/* ========= 관측치 편의 ========= */
function enableWheelStep(el){
  el.addEventListener('wheel',(e)=>{
    if(document.activeElement!==el) return;
    e.preventDefault();
    const delta = e.deltaY < 0 ? 1 : -1;
    let curr = parseInt(el.value || "0", 10);
    curr += delta;
    if (curr < 1) curr = 1;
    if (curr > 100) curr = 100;
    el.value = String(curr);
  }, {passive:false});
}
[obsatk,obshp,obsdef,obsagi].forEach(enableWheelStep);
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-delta][data-target]'); if(!btn) return;
  const id = btn.getAttribute('data-target'); const delta = parseInt(btn.getAttribute('data-delta'),10);
  const input=document.getElementById(id); if(!input) return;
  let curr=parseInt(input.value||"0",10); 
  curr += delta;
  if (curr < 1) curr = 1;
  if (curr > 100) curr = 100;
  input.value = String(curr);
});

/* ========= k/u 추정 ========= */
//const ESET = [575, 555, 535, 515, 495, 475, 455, 435];
const ESET = Array.from({length: ((575-435)/5)+1 }, (_,i) => 575 - i*5);

function solveUFromSG_JJYAL(SG, e){
try{
if(!SG || ![SG.hp,SG.atk,SG.def,SG.agi].every(Number.isFinite)) return null;
Decimal.set({ precision:50, rounding: Decimal.ROUND_HALF_UP });

const eD = new Decimal(e);
const f = eD.dividedBy(10000);
const d = new Decimal(SG.agi).times(10000).dividedBy(eD).minus(2.5);
const dRound = d.round();
const dPlus25 = dRound.plus(2.5);

const rhs1 = new Decimal(SG.hp).minus( dPlus25.times(f) ).dividedBy(f);
const rhs2 = new Decimal(SG.atk).minus( dPlus25.times(f).times(0.05) ).dividedBy(f);
const rhs3 = new Decimal(SG.def).minus( dPlus25.times(f).times(0.05) ).dividedBy(f);

let A = [
[ new Decimal(4), new Decimal(1), new Decimal(1), rhs1 ],
[ new Decimal(0.1), new Decimal(1), new Decimal(0.1), rhs2 ],
[ new Decimal(0.1), new Decimal(0.1), new Decimal(1), rhs3 ],
];
for(let i=0;i<3;i++){
let mr=i; let mv=A[i][i].abs();
for(let j=i+1;j<3;j++){ const t=A[j][i].abs(); if(t.greaterThan(mv)){mr=j; mv=t;} }
if(mr!==i){ const tmp=A[i]; A[i]=A[mr]; A[mr]=tmp; }
const piv=A[i][i];
for(let j=i;j<4;j++) A[i][j]=A[i][j].dividedBy(piv);
for(let k=0;k<3;k++){
if(k===i) continue;
const fac=A[k][i];
for(let j=i;j<4;j++) A[k][j]=A[k][j].minus( fac.times(A[i][j]) );
}
}
const aPrime=A[0][3], bPrime=A[1][3], cPrime=A[2][3];

const u_hp = aPrime.minus(2.5).round();
const u_atk = bPrime.minus(2.5).round();
const u_def = cPrime.minus(2.5).round();
const u_agi = dRound;

const r2 = x => new Decimal(x).toDecimalPlaces(2);
const hp_chk = r2( f.times( u_hp.plus(2.5).times(4).plus(u_atk.plus(2.5)).plus(u_def.plus(2.5)).plus(u_agi.plus(2.5)) ) );
const atk_chk = r2( f.times( u_hp.plus(2.5).times(0.1).plus(u_atk.plus(2.5)).plus(u_def.plus(2.5).times(0.1)).plus(u_agi.plus(2.5).times(0.05)) ) );
const def_chk = r2( f.times( u_hp.plus(2.5).times(0.1).plus(u_atk.plus(2.5).times(0.1)).plus(u_def.plus(2.5)).plus(u_agi.plus(2.5).times(0.05)) ) );
const agi_chk = r2( f.times( u_agi.plus(2.5) ) );

const err = hp_chk.minus(r2(SG.hp)).abs()
.plus(atk_chk.minus(r2(SG.atk)).abs())
.plus(def_chk.minus(r2(SG.def)).abs())
.plus(agi_chk.minus(r2(SG.agi)).abs());

return { u:{hp:+u_hp, atk:+u_atk, def:+u_def, agi:+u_agi}, e, sg_err:+err };
}catch(e){ return null; }
}

function s0_from_k_u_jjyal(k,u){
const fac = k/100;
const vhp = (u.hp + 2.5) * fac;
const vatk = (u.atk+ 2.5) * fac;
const vdef = (u.def+ 2.5) * fac;
const vagi = (u.agi+ 2.5) * fac;
const s_hp = Math.floor(vhp*4 + vatk + vdef + vagi);
const s_atk= Math.floor(vhp*0.1 + vatk + vdef*0.1 + vagi*0.05);
const s_def= Math.floor(vhp*0.1 + vatk*0.1 + vdef + vagi*0.05);
const s_agi= Math.floor(vagi);
return [s_hp,s_atk,s_def,s_agi];
}
function fitKFromS0_JJYAL(S0int,u){
let best=null;
for(let k=10;k<=100;k++){
const s = s0_from_k_u_jjyal(k,u);
const l1 = Math.abs(s[0]-S0int[0]) + Math.abs(s[1]-S0int[1]) + Math.abs(s[2]-S0int[2]) + Math.abs(s[3]-S0int[3]);
const ok = (l1===0);
if(!best || (ok && !best.ok)
|| (!best.ok && l1<best.l1)) best={k,l1,ok};
if(ok) break;
}
return best;
}
function inferKU_JJYAL(S0, SG){
const S0int = S0.map(x=>Math.floor(x));
let best=null;
for(const e of ESET){
const sol = solveUFromSG_JJYAL(SG, e);
if(!sol) continue;
const fit = fitKFromS0_JJYAL(S0int, sol.u);
if(!fit) continue;
const score = (fit.ok?0:1000) + fit.l1*10 + (sol.sg_err||0);
const cand = {k:fit.k, u:sol.u, e, sg_err:sol.sg_err, s0_l1:fit.l1, s0_ok:fit.ok, score};
if(!best || cand.score<best.score) best=cand;
}
return best;
}

/* ========= 엔진(합산 후 floor) ========= */
function enumerate_jjyal(pku, obs){
const k = new Decimal(pku.k);
const fac = k.dividedBy(100);
const u = pku.u;

let matches = 0, rank8 = 0;
const dist = {};

for(let ar=-2; ar<=2; ar++){
for(let dr=-2; dr<=2; dr++){
for(let gr=-2; gr<=2; gr++){
for(let hr=-2; hr<=2; hr++){
for(let ab=0; ab<=10; ab++){
for(let db=0; db<=10; db++){
for(let gb=0; gb<=10; gb++){
const hb = 10 - ab - db - gb;
if(hb < 0 || hb > 10) continue;

const baseA = new Decimal(u.atk + ar + ab);
const baseD = new Decimal(u.def + dr + db);
const baseG = new Decimal(u.agi + gr + gb);
const baseH = new Decimal(u.hp + hr + hb);

const iA = baseA.times(fac);
const iD = baseD.times(fac);
const iG = baseG.times(fac);
const iH = baseH.times(fac);

const calcAtk = iH.times(0.1).plus(iA).plus(iD.times(0.1)).plus(iG.times(0.05)).floor().toNumber();
const calcDef = iH.times(0.1).plus(iA.times(0.1)).plus(iD).plus(iG.times(0.05)).floor().toNumber();
const calcAgi = iG.floor().toNumber();
const calcHp = iH.times(4).plus(iA).plus(iD).plus(iG).floor().toNumber();

if(calcAtk===obs[1] && calcDef===obs[2] && calcAgi===obs[3] && calcHp===obs[0]){
matches++;
const r = ar + dr + gr + hr;
dist[r] = (dist[r]||0) + 1;
if(r === 8) rank8++;
}
}
}
}
}
}
}
}
return {matches, rank8, dist};
}

/* ========= 계산 ========= */
btnCalc.addEventListener('click', async ()=>{
if(!selectedName){ alert("페트를 먼저 선택하세요."); return; }
const obs=[obshp,obsatk,obsdef,obsagi].map(e=>parseInt(e.value,10));
if(obs.some(v=>!Number.isFinite(v))){ alert("관측 표기치(정수)를 모두 입력하세요."); return; }

const row=GLOBAL_TABLE[selectedName]||{};
if(!row?.s0 || !row?.sg){ alert("이 페트는 S0/SG가 등록되어 있지 않습니다."); return; }

let k=row.k, u=row.u;
if(!(Number.isFinite(k) && u && [u.hp,u.atk,u.def,u.agi].every(Number.isFinite))){
const S0=[row.s0.hp, row.s0.atk, row.s0.def, row.s0.agi];
const SG=row.sg;
const fit = inferKU_JJYAL(S0, SG);
if(!fit){ alert("k/u 추정 실패: S0/SG를 확인하세요."); return; }
k=fit.k; u=fit.u;
}
const res = enumerate_jjyal({k,u}, obs);
showKpis(res);
});

btnReset.addEventListener('click', ()=>{
selectedName=null; selectedRow=null;
petSearch.value=""; currentChosung="";
Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
petList.querySelectorAll('.item.selected').forEach(el=>el.classList.remove('selected'));
selectedItemEl = null;
renderPetList();
[s0hp,s0atk,s0def,s0agi,sghp,sgatk,sgdef,sgagi,obshp,obsatk,obsdef,obsagi].forEach(i=>i.value="");
showKpis(null);
});
btnClear.addEventListener('click', ()=>{
petSearch.value=""; currentChosung="";
renderChosungTokens();
Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
petList.querySelectorAll('.item.selected').forEach(el=>el.classList.remove('selected'));
selectedItemEl = null;
renderPetList();
});

// ====== 관측치 입력: 정수 + 1~100 범위 제한 ======
const intOnlyInputs = [obshp, obsatk, obsdef, obsagi];

intOnlyInputs.forEach(input => {
  // ① HTML 속성 반영
  input.min = 1;
  input.max = 100;
  input.step = 1;

  // ② 소수점, 음수, e/E, 콤마 입력 차단
  input.addEventListener('keydown', (e) => {
    if (['.', ',', 'e', 'E', '-'].includes(e.key)) {
      e.preventDefault();
    }
  });

  // ③ 붙여넣기 및 직접 입력 시 숫자만 + 범위 자동 보정
  input.addEventListener('input', () => {
    let val = input.value.replace(/\D/g, ''); // 숫자만 남김
    if (val === '') return (input.value = '');
    let num = parseInt(val, 10);
    if (num < 1) num = 1;
    if (num > 100) num = 100;
    input.value = num;
  });
});
  
/* ========= 부팅 ========= */
(async function init(){
console.log("[init] start");
FAVS = loadFavs();
renderFavChips();
await loadGlobalTable();
await loadRank8Map();
console.log("[init] pets:", Object.keys(GLOBAL_TABLE).length, "rank8 keys:", Object.keys(R8MAP).length);
renderPetList();
})();
</script>
</body>
</html>
